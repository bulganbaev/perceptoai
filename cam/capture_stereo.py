import cv2
import os
import time
from camera_driver import StereoCameraSystem

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫–∏, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
os.makedirs("data/images/left", exist_ok=True)
os.makedirs("data/images/right", exist_ok=True)

# –ó–∞–ø—É—Å–∫–∞–µ–º –¥–≤–µ –∫–∞–º–µ—Ä—ã
stereoCam = StereoCameraSystem()
stereoCam.start()

image_count = 0

print("üì∏ –ù–∞–∂–º–∏—Ç–µ 's' –¥–ª—è —Å—ä–µ–º–∫–∏, 'q' –¥–ª—è –≤—ã—Ö–æ–¥–∞")
try:
    while True:
        frame0, frame1 = stereoCam.get_synchronized_frames()

        if frame0 is not None and frame1 is not None:
            combined = cv2.hconcat([frame0, frame1])
            cv2.namedWindow("Dual Cameras", cv2.WINDOW_NORMAL)  # –î–µ–ª–∞–µ–º –æ–∫–Ω–æ –∏–∑–º–µ–Ω—è–µ–º—ã–º
            cv2.resizeWindow("Dual Cameras", 1920, 1080) 
            cv2.imshow("Dual Cameras", combined)

        key = cv2.waitKey(1) & 0xFF

        if key == ord('s'):
            filename_left = f"data/images/left/left_{image_count:02d}.jpg"
            filename_right = f"data/images/right/right_{image_count:02d}.jpg"

            cv2.imwrite(filename_left, frame0)
            cv2.imwrite(filename_right, frame1)

            print(f"‚úÖ –°–Ω–∏–º–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {filename_left}, {filename_right}")
            image_count += 1
            time.sleep(0.5)  # –ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–≤–æ–π–Ω–æ–≥–æ —Å–Ω–∏–º–∫–∞

        elif key == ord('q'):
            break

except KeyboardInterrupt:
    pass

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—ã
stereoCam.stop()
cv2.destroyAllWindows()
print("üìÅ –í—Å–µ —Å–Ω–∏–º–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ 'images/left' –∏ 'images/right'")
